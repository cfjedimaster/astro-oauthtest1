---
const CLIENT_ID = Astro.locals.runtime.env.CLIENT_ID;
const CLIENT_SECRET = Astro.locals.runtime.env.CLIENT_SECRET;
const REDIRECT_URL = Astro.locals.runtime.env.REDIRECT_URL;

const code = Astro.url.searchParams.get('code') || '';
const error = Astro.url.searchParams.get('error') || '';

const base = import.meta.env.BASE_URL;

if(error !== '') {
    // todo, handle error 
    // maybe a flash msg and back to index
    console.error('Error!!', error);
    return Astro.redirect('/app');
    
}

// get our access token
const params = new URLSearchParams();
params.append('client_id', CLIENT_ID);
params.append('client_secret', CLIENT_SECRET);
params.append('grant_type', 'authorization_code');
params.append('code', code);


const atReq = await fetch('https://api.webflow.com/oauth/access_token', {
    method: 'POST',
    headers: {
        'Accept': 'application/json',
        'Content-Type2': 'application/x-www-form-urlencoded'
    }, 
    body: params
});

const at = await atReq.json();
console.log('at', at);
await Astro.session?.set('access_token', at.access_token);
return Astro.redirect(base);
---
