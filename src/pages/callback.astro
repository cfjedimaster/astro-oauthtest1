---
const CLIENT_ID = Astro.locals.runtime.env.CLIENT_ID;
const CLIENT_SECRET = Astro.locals.runtime.env.CLIENT_SECRET;
const REDIRECT_URL = Astro.locals.runtime.env.REDIRECT_URL;

const code = Astro.url.searchParams.get('code') || '';
const error = Astro.url.searchParams.get('error') || '';

if(error !== '') {
    // todo, handle error 
    // maybe a flash msg and back to index
    console.error('Error!!', error);
    return Astro.redirect('/app');
    
}

/*
    # exchange the authorization code for an access token
    response = requests.post("https://api.webflow.com/oauth/access_token", data={
        'client_id': CLIENT_ID,
        'client_secret': CLIENT_SECRET,
        'code': request.args['code'],
        'grant_type': 'authorization_code',
        'redirect_uri': REDIRECT_URL,
    }, headers={'Accept': 'application/json'})

    */

// get our access token
const params = new URLSearchParams();
params.append('client_id', CLIENT_ID);
params.append('client_secret', CLIENT_SECRET);
params.append('grant_type', 'authorization_code');
params.append('code', code);


const atReq = await fetch('https://api.webflow.com/oauth/access_token', {
    method: 'POST',
    headers: {
        'Accept': 'application/json',
        'Content-Type2': 'application/x-www-form-urlencoded'
    }, 
    body: params
});

const at = await atReq.json();
console.log('at', at);
Astro.session?.set('access_token', at.access_token);
return Astro.redirect('/app');
    

---
